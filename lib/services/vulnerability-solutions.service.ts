/**
 * Vulnerability Solutions Service
 * Provides detailed step-by-step solutions for security vulnerabilities
 */

export interface VulnerabilitySolution {
  vulnerabilityName: string;
  severity: 'critical' | 'high' | 'medium' | 'low';
  description: string;
  cause: string;
  recommendation: string;
  steps: {
    title: string;
    description: string;
    code?: string;
    language?: string;
  }[];
  references: string[];
}

export class VulnerabilitySolutionsService {
  private solutions: Map<string, VulnerabilitySolution> = new Map();

  constructor() {
    this.initializeSolutions();
  }

  private initializeSolutions() {
    // Missing Security Headers
    this.solutions.set('missing-security-headers', {
      vulnerabilityName: 'Missing Security Headers',
      severity: 'high',
      description: 'The target is missing critical security headers that protect against common web attacks such as XSS, clickjacking, and MIME-type sniffing.',
      cause: 'Security headers are not configured in the web server or application framework. This leaves the application vulnerable to various client-side attacks.',
      recommendation: 'Implement all recommended security headers in your web server configuration or application middleware.',
      steps: [
        {
          title: 'Step 1: Add Content-Security-Policy (CSP)',
          description: 'CSP helps prevent XSS attacks by controlling which resources can be loaded.',
          code: `# For Nginx
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';" always;

# For Apache
Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';"

# For Express.js
app.use((req, res, next) => {
  res.setHeader("Content-Security-Policy", "default-src 'self'; script-src 'self' 'unsafe-inline'");
  next();
});`,
          language: 'nginx'
        },
        {
          title: 'Step 2: Add X-Frame-Options',
          description: 'Prevents clickjacking attacks by controlling if your site can be embedded in iframes.',
          code: `# For Nginx
add_header X-Frame-Options "SAMEORIGIN" always;

# For Apache
Header always set X-Frame-Options "SAMEORIGIN"

# For Express.js
app.use((req, res, next) => {
  res.setHeader("X-Frame-Options", "SAMEORIGIN");
  next();
});`,
          language: 'nginx'
        },
        {
          title: 'Step 3: Add X-Content-Type-Options',
          description: 'Prevents MIME-type sniffing attacks.',
          code: `# For Nginx
add_header X-Content-Type-Options "nosniff" always;

# For Apache
Header always set X-Content-Type-Options "nosniff"

# For Express.js
app.use((req, res, next) => {
  res.setHeader("X-Content-Type-Options", "nosniff");
  next();
});`,
          language: 'nginx'
        },
        {
          title: 'Step 4: Add Strict-Transport-Security (HSTS)',
          description: 'Forces browsers to use HTTPS connections only.',
          code: `# For Nginx
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

# For Apache
Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"

# For Express.js
app.use((req, res, next) => {
  res.setHeader("Strict-Transport-Security", "max-age=31536000; includeSubDomains");
  next();
});`,
          language: 'nginx'
        },
        {
          title: 'Step 5: Add X-XSS-Protection',
          description: 'Enables browser XSS filtering (legacy browsers).',
          code: `# For Nginx
add_header X-XSS-Protection "1; mode=block" always;

# For Apache
Header always set X-XSS-Protection "1; mode=block"

# For Express.js
app.use((req, res, next) => {
  res.setHeader("X-XSS-Protection", "1; mode=block");
  next();
});`,
          language: 'nginx'
        },
        {
          title: 'Step 6: Add Referrer-Policy',
          description: 'Controls how much referrer information is shared.',
          code: `# For Nginx
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# For Apache
Header always set Referrer-Policy "strict-origin-when-cross-origin"

# For Express.js
app.use((req, res, next) => {
  res.setHeader("Referrer-Policy", "strict-origin-when-cross-origin");
  next();
});`,
          language: 'nginx'
        },
        {
          title: 'Step 7: Add Permissions-Policy',
          description: 'Controls which browser features can be used.',
          code: `# For Nginx
add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

# For Apache
Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"

# For Express.js
app.use((req, res, next) => {
  res.setHeader("Permissions-Policy", "geolocation=(), microphone=(), camera=()");
  next();
});`,
          language: 'nginx'
        },
        {
          title: 'Step 8: Verify Implementation',
          description: 'Test your headers using online tools or browser developer tools.',
          code: `# Using curl to check headers
curl -I https://yourdomain.com

# Using online tools:
# - https://securityheaders.com
# - https://observatory.mozilla.org`,
          language: 'bash'
        }
      ],
      references: [
        'https://owasp.org/www-project-secure-headers/',
        'https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers',
        'https://securityheaders.com',
        'https://cheatsheetseries.owasp.org/cheatsheets/HTTP_Headers_Cheat_Sheet.html'
      ]
    });

    // Outdated TLS Configuration
    this.solutions.set('outdated-tls', {
      vulnerabilityName: 'Outdated TLS Configuration',
      severity: 'medium',
      description: 'The server supports older TLS versions (TLS 1.0/1.1) that have known security vulnerabilities.',
      cause: 'Legacy TLS protocols are enabled for backward compatibility but contain cryptographic weaknesses.',
      recommendation: 'Disable TLS 1.0 and 1.1, use only TLS 1.2 and TLS 1.3 with strong cipher suites.',
      steps: [
        {
          title: 'Step 1: Update Nginx Configuration',
          description: 'Configure Nginx to use only modern TLS versions.',
          code: `# Edit /etc/nginx/nginx.conf or your site config
ssl_protocols TLSv1.2 TLSv1.3;
ssl_prefer_server_ciphers on;
ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';`,
          language: 'nginx'
        },
        {
          title: 'Step 2: Update Apache Configuration',
          description: 'Configure Apache to use only modern TLS versions.',
          code: `# Edit /etc/apache2/mods-available/ssl.conf
SSLProtocol -all +TLSv1.2 +TLSv1.3
SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
SSLHonorCipherOrder on`,
          language: 'apache'
        },
        {
          title: 'Step 3: Restart Web Server',
          description: 'Apply the changes by restarting your web server.',
          code: `# For Nginx
sudo systemctl restart nginx

# For Apache
sudo systemctl restart apache2`,
          language: 'bash'
        },
        {
          title: 'Step 4: Test TLS Configuration',
          description: 'Verify your TLS configuration using SSL Labs.',
          code: `# Visit SSL Labs
https://www.ssllabs.com/ssltest/analyze.html?d=yourdomain.com

# Or use testssl.sh
./testssl.sh yourdomain.com`,
          language: 'bash'
        }
      ],
      references: [
        'https://wiki.mozilla.org/Security/Server_Side_TLS',
        'https://www.ssllabs.com/ssltest/',
        'https://cipherlist.eu/'
      ]
    });

    // Cookie Security Issues
    this.solutions.set('cookie-security', {
      vulnerabilityName: 'Insecure Cookie Configuration',
      severity: 'medium',
      description: 'Cookies are not configured with Secure, HttpOnly, and SameSite flags, making them vulnerable to theft.',
      cause: 'Application or framework does not set proper cookie security attributes.',
      recommendation: 'Set Secure, HttpOnly, and SameSite attributes on all cookies.',
      steps: [
        {
          title: 'Step 1: Configure Secure Flag',
          description: 'Ensure cookies are only sent over HTTPS.',
          code: `// Express.js
app.use(session({
  cookie: {
    secure: true, // Only send over HTTPS
    httpOnly: true,
    sameSite: 'strict'
  }
}));

// PHP
setcookie('name', 'value', [
  'secure' => true,
  'httponly' => true,
  'samesite' => 'Strict'
]);`,
          language: 'javascript'
        },
        {
          title: 'Step 2: Set HttpOnly Flag',
          description: 'Prevent JavaScript access to cookies.',
          code: `// This prevents XSS attacks from stealing cookies
res.cookie('sessionId', value, {
  httpOnly: true,
  secure: true,
  sameSite: 'strict'
});`,
          language: 'javascript'
        },
        {
          title: 'Step 3: Configure SameSite Attribute',
          description: 'Protect against CSRF attacks.',
          code: `// Options: 'strict', 'lax', or 'none'
res.cookie('token', value, {
  sameSite: 'strict', // Most secure
  secure: true,
  httpOnly: true
});`,
          language: 'javascript'
        }
      ],
      references: [
        'https://owasp.org/www-community/controls/SecureCookieAttribute',
        'https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies'
      ]
    });
  }

  getSolution(vulnerabilityId: string): VulnerabilitySolution | undefined {
    return this.solutions.get(vulnerabilityId);
  }

  getAllSolutions(): VulnerabilitySolution[] {
    return Array.from(this.solutions.values());
  }

  findSolutionByName(name: string): VulnerabilitySolution | undefined {
    const normalized = name.toLowerCase();
    for (const solution of this.solutions.values()) {
      if (solution.vulnerabilityName.toLowerCase().includes(normalized)) {
        return solution;
      }
    }
    return undefined;
  }
}
